{
  "id": 141,
  "title": "start_funkit",
  "body": "#!/usr/bin/env bash\nset -Eeuo pipefail\n\n# --- Defaults (you can override before running) ---\n: \"${PIKIT_OPENAI_API_KEY:=}\"                 # empty = no auth header\n: \"${PIKIT_MODEL_NAME:=}\"                     # if empty, we\u2019ll pick the first listed\n: \"${PIKIT_MAX_TOKENS_DEFAULT:=256}\"\nCANDIDATES=(\"http://localhost:8081/v1\" \"http://localhost:8080/v1\")\n\ncurl_ok() {\n  # Usage: curl_ok <url> [auth_header]\n  local url=\"$1\"; shift || true\n  local auth=\"${1:-}\"\n  if [[ -n \"$auth\" ]]; then\n    curl -fsS -m 3 -H \"Authorization: Bearer ${auth}\" \"$url\" >/dev/null\n  else\n    curl -fsS -m 3 \"$url\" >/dev/null\n  fi\n}\n\nhttp_code() {\n  # Usage: http_code <url> [auth_header]\n  local url=\"$1\"; shift || true\n  local auth=\"${1:-}\"\n  if [[ -n \"$auth\" ]]; then\n    curl -s -o /dev/null -m 5 -w \"%{http_code}\" -H \"Authorization: Bearer ${auth}\" \"$url\"\n  else\n    curl -s -o /dev/null -m 5 -w \"%{http_code}\" \"$url\"\n  fi\n}\n\npick_base_url() {\n  for base in \"${CANDIDATES[@]}\"; do\n    if curl_ok \"${base}/models\"; then\n      echo \"$base\"; return 0\n    fi\n  done\n  # Try with key if user already set one\n  if [[ -n \"${PIKIT_OPENAI_API_KEY}\" ]]; then\n    for base in \"${CANDIDATES[@]}\"; do\n      if curl_ok \"${base}/models\" \"${PIKIT_OPENAI_API_KEY}\"; then\n        echo \"$base\"; return 0\n      fi\n    done\n  fi\n  return 1\n}\n\ndetect_auth_mode() {\n  local base=\"$1\"\n  local code_no_key; code_no_key=\"$(http_code \"${base}/models\")\" || code_no_key=000\n  if [[ \"$code_no_key\" == \"200\" ]]; then\n    echo \"none\"; return 0\n  fi\n  # If no-key didn\u2019t work, try with key (supply default if not provided)\n  local key=\"${PIKIT_OPENAI_API_KEY:-sk-local}\"\n  local code_with_key; code_with_key=\"$(http_code \"${base}/models\" \"$key\")\" || code_with_key=000\n  if [[ \"$code_with_key\" == \"200\" ]]; then\n    echo \"key:$key\"; return 0\n  fi\n  echo \"fail\"; return 1\n}\n\nfirst_model_id() {\n  # Extract first \"id\" from /models JSON without jq\n  local base=\"$1\"; shift || true\n  local key=\"${1:-}\"\n  local out\n  if [[ -n \"$key\" ]]; then\n    out=\"$(curl -fsS \"${base}/models\" -H \"Authorization: Bearer ${key}\")\"\n  else\n    out=\"$(curl -fsS \"${base}/models\")\"\n  fi\n  # Grep the first id\n  echo \"$out\" | grep -o '\"id\":\"[^\"]\\+\"' | head -n1 | sed 's/^\"id\":\"//; s/\"$//'\n}\n\n# ---- Run detection ----\nBASE_URL=\"$(pick_base_url || true)\"\nif [[ -z \"${BASE_URL}\" ]]; then\n  echo \"\u274c Could not reach LocalAI on 8081 or 8080 (/v1/models). Is it running?\"\n  exit 1\nfi\n\nAUTH_MODE=\"$(detect_auth_mode \"$BASE_URL\" || true)\"\nif [[ \"$AUTH_MODE\" == \"none\" ]]; then\n  USE_KEY=\"\"\nelif [[ \"$AUTH_MODE\" == key:* ]]; then\n  USE_KEY=\"${AUTH_MODE#key:}\"\nelse\n  echo \"\u274c /models not accessible on ${BASE_URL} (with or without key).\"\n  exit 1\nfi\n\n# Determine model\nif [[ -z \"${PIKIT_MODEL_NAME}\" ]]; then\n  if [[ -n \"$USE_KEY\" ]]; then\n    PIKIT_MODEL_NAME=\"$(first_model_id \"$BASE_URL\" \"$USE_KEY\")\"\n  else\n    PIKIT_MODEL_NAME=\"$(first_model_id \"$BASE_URL\")\"\n  fi\nfi\n\nif [[ -z \"${PIKIT_MODEL_NAME}\" ]]; then\n  echo \"\u274c No model ID found at ${BASE_URL}/models. Load a model in LocalAI first.\"\n  exit 1\nfi\n\n# ---- Export env & launch ----\nexport PIKIT_OPENAI_BASE_URL=\"$BASE_URL\"\nexport PIKIT_MODEL_NAME\nexport PIKIT_MAX_TOKENS_DEFAULT\n\nif [[ -n \"$USE_KEY\" ]]; then\n  export PIKIT_OPENAI_API_KEY=\"$USE_KEY\"\n  echo \"\ud83d\udd10 Using API key auth against ${BASE_URL}\"\nelse\n  unset PIKIT_OPENAI_API_KEY\n  echo \"\ud83d\udd13 No API key required on ${BASE_URL}\"\nfi\n\necho \"\u25b6 Model: ${PIKIT_MODEL_NAME}\"\necho \"\u25b6 Max tokens default: ${PIKIT_MAX_TOKENS_DEFAULT}\"\n\ncd \"$HOME/src/FunKit\"\nexec python3 main.py\n\n"
}