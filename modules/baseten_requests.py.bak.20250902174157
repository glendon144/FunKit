# modules/baseten_requests.py
import os, requests, json

BASE = os.getenv("BASETEN_BASE_URL", "https://inference.baseten.co/v1").rstrip("/")
URL  = f"{BASE}/chat/completions"

def chat_once(messages, model=None, temperature=0.7, max_tokens=512):
    model = model or os.getenv("BASETEN_MODEL") or "openai/gpt-oss-120b"
    key = os.getenv("BASETEN_API_KEY", "")
    if not key:
        raise RuntimeError("BASETEN_API_KEY not set")

    headers = {
        "Authorization": f"Bearer {key}",
        "Content-Type": "application/json",
        "Accept": "application/json",
    }
    payload = {
        "model": model,
        "messages": messages,
        "temperature": temperature,
        "max_tokens": max_tokens,
    }

    r = requests.post(URL, headers=headers, json=payload, timeout=60, allow_redirects=False)
    ct = r.headers.get("Content-Type", "")
    if r.status_code >= 400:
        snippet = (r.text or "")[:800]
        raise RuntimeError(f"[Baseten requests] POST {URL} -> {r.status_code} CT={ct}\n{snippet}")

    try:
        data = r.json()
    except Exception:
        raise RuntimeError(f"[Baseten requests] Non-JSON from {URL} CT={ct}: {(r.text or '')[:400]}")

    try:
        return data["choices"][0]["message"]["content"]
    except Exception:
        return json.dumps(data, ensure_ascii=False)

